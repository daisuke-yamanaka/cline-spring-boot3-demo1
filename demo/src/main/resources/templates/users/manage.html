<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/layout :: head">
</head>
<body>
    <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
    <nav th:replace="fragments/layout :: sidebar"></nav>

    <main>
        <!-- „Ç¶„Çß„É´„Ç´„É†„Çª„ÇØ„Ç∑„Éß„É≥ -->
        <div class="welcome-section">
            <h1>„É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ</h1>
            <p>„Ç∑„Çπ„ÉÜ„É†„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Çã„É¶„Éº„Ç∂„Éº„ÅÆÁÆ°ÁêÜ„ÇÑÊñ∞Ë¶èÁôªÈå≤„ÇíË°å„ÅÜ„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ</p>
        </div>

        <!-- Áµ±Ë®àÊÉÖÂ†± -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>
                    <i class="fas fa-users"></i>
                    Á∑è„É¶„Éº„Ç∂„ÉºÊï∞
                </h3>
                <div class="stat-number" th:text="${totalUsers ?: 0}">0</div>
            </div>
            <div class="stat-card">
                <h3>
                    <i class="fas fa-user-shield"></i>
                    ÁÆ°ÁêÜËÄÖÊï∞
                </h3>
                <div class="stat-number" th:text="${adminCount ?: 0}">0</div>
            </div>
            <div class="stat-card">
                <h3>
                    <i class="fas fa-user-clock"></i>
                    „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É¶„Éº„Ç∂„Éº
                </h3>
                <div class="stat-number" th:text="${activeUsers ?: 0}">0</div>
            </div>
            <div class="stat-card">
                <h3>
                    <i class="fas fa-user-lock"></i>
                    „Éñ„É≠„ÉÉ„ÇØ‰∏≠
                </h3>
                <div class="stat-number" th:text="${blockedUsers ?: 0}">0</div>
            </div>
        </div>

        <!-- „É¶„Éº„Ç∂„ÉºÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥ -->
        <div class="book-section">
            <div class="section-title">
                <i class="fas fa-users"></i>
                „É¶„Éº„Ç∂„Éº‰∏ÄË¶ß
            </div>
            
            <!-- Êñ∞Ë¶è„É¶„Éº„Ç∂„ÉºÁôªÈå≤„Éú„Çø„É≥ -->
            <button type="button" class="action-button primary-action mb-3" data-bs-toggle="modal" data-bs-target="#userFormModal">
                <i class="fas fa-user-plus"></i>
                Êñ∞Ë¶è„É¶„Éº„Ç∂„ÉºÁôªÈå≤
            </button>

            <!-- „É¶„Éº„Ç∂„Éº‰∏ÄË¶ß„ÉÜ„Éº„Éñ„É´ -->
            <div id="userGrid" class="mt-4"></div>
        </div>

        <!-- „É¶„Éº„Ç∂„Éº„Éï„Ç©„Éº„É†„É¢„Éº„ÉÄ„É´ -->
        <div class="modal fade" id="userFormModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="userForm">
                            <input type="hidden" id="userId">
                            <input type="hidden" id="csrfToken" th:value="${_csrf.token}"/>
                            <input type="hidden" id="csrfHeader" th:value="${_csrf.headerName}"/>
                            <div class="form-group">
                                <label for="username">„É¶„Éº„Ç∂„ÉºÂêç</label>
                                <input type="text" class="form-control" id="username" required minlength="4" maxlength="20">
                                <small class="text-muted">ÂçäËßíËã±Êï∞Â≠ó„Åß4ÊñáÂ≠ó‰ª•‰∏ä20ÊñáÂ≠ó‰ª•ÂÜÖ</small>
                            </div>
                            <div class="form-group">
                                <label for="displayName">Ë°®Á§∫Âêç</label>
                                <input type="text" class="form-control" id="displayName" required maxlength="50">
                                <small class="text-muted">50ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>
                            </div>
                            <div class="form-group">
                                <label for="email">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="form-group">
                                <label for="password">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                                <input type="password" class="form-control" id="password" minlength="8">
                                <small class="text-muted">Êõ¥Êñ∞ÊôÇ„ÅØÁ©∫ÁôΩ„ÅÆ„Åæ„Åæ„Å´„Åô„Çã„Å®Êó¢Â≠ò„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÁ∂≠ÊåÅ„Åï„Çå„Åæ„Åô</small>
                            </div>
                            <div class="form-group">
                                <label for="role">Ê®©Èôê</label>
                                <select class="form-select" id="role" required>
                                    <option value="ROLE_USER">‰∏ÄËà¨„É¶„Éº„Ç∂„Éº</option>
                                    <option value="ROLE_ADMIN">ÁÆ°ÁêÜËÄÖ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="maxBorrowCount">ÊúÄÂ§ßË≤∏Âá∫Êï∞</label>
                                <input type="number" class="form-control" id="maxBorrowCount" required min="0" value="5">
                            </div>
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="isBlocked">
                                    <label class="form-check-label" for="isBlocked">„Ç¢„Ç´„Ç¶„É≥„Éà„Éñ„É≠„ÉÉ„ÇØ</label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="action-button secondary-action" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                        <button type="button" class="action-button primary-action" id="saveUser">‰øùÂ≠ò</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Grid.js -->
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
    <script th:inline="javascript">
        // CSRF„Éà„Éº„ÇØ„É≥„ÅÆÂèñÂæó
        const csrfToken = document.getElementById('csrfToken').value;
        const csrfHeader = document.getElementById('csrfHeader').value;

        // ÂÖ±ÈÄö„ÅÆ„Éï„Çß„ÉÉ„ÉÅ„Ç™„Éó„Ç∑„Éß„É≥
        function getFetchOptions(method = 'GET') {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            };

            if (csrfToken) {
                options.headers[csrfHeader] = csrfToken;
            }

            return options;
        }

        // Áµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
        async function updateStats() {
            try {
                const response = await fetch('/users/api/stats', getFetchOptions());
                if (!response.ok) {
                    throw new Error('Failed to fetch stats');
                }
                const stats = await response.json();
                
                // Áµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞
                const statCards = document.querySelectorAll('.stat-card .stat-number');
                statCards[0].textContent = stats.totalUsers;
                statCards[1].textContent = stats.adminCount;
                statCards[2].textContent = stats.activeUsers;
                statCards[3].textContent = stats.blockedUsers;
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        const grid = new gridjs.Grid({
            columns: [
                { id: 'userId', name: 'ID' },
                { id: 'username', name: '„É¶„Éº„Ç∂„ÉºÂêç' },
                { id: 'displayName', name: 'Ë°®Á§∫Âêç' },
                { id: 'email', name: '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ' },
                { id: 'role', name: 'Ê®©Èôê' },
                { id: 'maxBorrowCount', name: 'ÊúÄÂ§ßË≤∏Âá∫Êï∞' },
                { 
                    id: 'isBlocked',
                    name: '„Çπ„ÉÜ„Éº„Çø„Çπ',
                    formatter: (cell) => cell ? 'üîí „Éñ„É≠„ÉÉ„ÇØ‰∏≠' : '‚úÖ ÊúâÂäπ'
                },
                {
                    id: 'actions',
                    name: 'Êìç‰Ωú',
                    formatter: (_, row) => {
                        return gridjs.html(`
                            <div class="actions">
                                <button class="action-button secondary-action" onclick="editUser(${row.cells[0].data})">
                                    <i class="fas fa-edit"></i> Á∑®ÈõÜ
                                </button>
                                <button class="action-button primary-action" onclick="deleteUser(${row.cells[0].data})">
                                    <i class="fas fa-trash"></i> ÂâäÈô§
                                </button>
                            </div>
                        `);
                    }
                }
            ],
            server: {
                url: '/users/api/list',
                then: data => data.map(user => [
                    user.userId,
                    user.username,
                    user.displayName,
                    user.email,
                    user.role === 'ROLE_ADMIN' ? 'ÁÆ°ÁêÜËÄÖ' : '‰∏ÄËà¨„É¶„Éº„Ç∂„Éº',
                    user.maxBorrowCount,
                    user.isBlocked,
                ])
            },
            search: true,
            sort: true,
            pagination: {
                limit: 10
            },
            language: {
                search: {
                    placeholder: 'Ê§úÁ¥¢...'
                },
                pagination: {
                    previous: 'Ââç„Å∏',
                    next: 'Ê¨°„Å∏',
                    showing: 'Ë°®Á§∫‰∏≠',
                    results: () => '‰ª∂'
                }
            },
            className: {
                table: 'table table-hover'
            }
        }).render(document.getElementById("userGrid"));

        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞Èñ¢Êï∞
        async function handleResponse(response) {
            if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                const errorMessage = errorData?.message || `${response.status} ${response.statusText}`;
                throw new Error(errorMessage);
            }
            return response;
        }

        // „É¶„Éº„Ç∂„ÉºÁ∑®ÈõÜ
        function editUser(userId) {
            fetch(`/users/api/${userId}`, getFetchOptions())
                .then(handleResponse)
                .then(response => response.json())
                .then(user => {
                    document.getElementById('userId').value = user.userId;
                    document.getElementById('username').value = user.username;
                    document.getElementById('displayName').value = user.displayName;
                    document.getElementById('email').value = user.email;
                    document.getElementById('role').value = user.role;
                    document.getElementById('maxBorrowCount').value = user.maxBorrowCount;
                    document.getElementById('isBlocked').checked = user.isBlocked;
                    document.getElementById('password').value = '';
                    
                    new bootstrap.Modal(document.getElementById('userFormModal')).show();
                })
                .catch(error => {
                    alert(error.message);
                });
        }

        // „É¶„Éº„Ç∂„ÉºÂâäÈô§
        function deleteUser(userId) {
            if (confirm('„Åì„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                fetch(`/users/api/${userId}`, getFetchOptions('DELETE'))
                .then(handleResponse)
                .then(() => {
                    grid.forceRender();
                    updateStats(); // Áµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞
                })
                .catch(error => {
                    alert(error.message);
                });
            }
        }

        // „É¶„Éº„Ç∂„Éº‰øùÂ≠ò
        document.getElementById('saveUser').addEventListener('click', function() {
            const userId = document.getElementById('userId').value;
            const userData = {
                username: document.getElementById('username').value,
                displayName: document.getElementById('displayName').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value,
                maxBorrowCount: parseInt(document.getElementById('maxBorrowCount').value),
                isBlocked: document.getElementById('isBlocked').checked
            };

            if (userId) {
                userData.userId = parseInt(userId);
                if (!userData.password) {
                    delete userData.password;
                }
            }

            const method = userId ? 'PUT' : 'POST';
            const url = userId ? `/users/api/${userId}` : '/users/api/create';

            const options = getFetchOptions(method);
            options.body = JSON.stringify(userData);

            fetch(url, options)
            .then(handleResponse)
            .then(() => {
                bootstrap.Modal.getInstance(document.getElementById('userFormModal')).hide();
                document.getElementById('userForm').reset();
                grid.forceRender();
                updateStats(); // Áµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            })
            .catch(error => {
                alert(error.message);
            });
        });

        // „É¢„Éº„ÉÄ„É´„ÅåÈñâ„Åò„Çâ„Çå„Åü„Å®„Åç„Å´„Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
        document.getElementById('userFormModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
        });
    </script>
</body>
</html>
